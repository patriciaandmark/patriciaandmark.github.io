<h2>RSVP</h2>
<style>
  .rsvp-layout {
    display: grid;
    gap: 2rem;
    margin: 2rem auto;
    max-width: 1100px;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
  }

  .rsvp-form {
    background: #fff;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.05);
    text-align: left;
  }

  .guest-search label {
    display: block;
    font-weight: 600;
    color: #5e524b;
  }

  .guest-search-field {
    display: flex;
    gap: 0.75rem;
    margin-top: 0.5rem;
    flex-wrap: wrap;
  }

  .guest-search input[type="search"] {
    flex: 1;
    padding: 0.75rem;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-family: 'Inter', sans-serif;
  }

  .guest-search button {
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    border: none;
    background: #c9bab0;
    color: #fff;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.3s;
  }
  .guest-search button:hover,
  .guest-search button:focus {
    background: #b3a69c;
    outline: none;
  }

  @media (max-width: 540px) {
    .guest-search-field {
      flex-direction: column;
      align-items: stretch;
    }
    .guest-search button {
      width: 100%;
    }
  }

  .search-results {
    margin-top: 0.5rem;
    border: 1px solid #e8e0d8;
    border-radius: 8px;
    background: #fff;
    box-shadow: 0 10px 18px rgba(0, 0, 0, 0.06);
    max-height: 220px;
    overflow-y: auto;
    display: none;
  }
  .search-results.is-visible { display: block; }

  .search-result {
    display: flex;
    justify-content: space-between;
    width: 100%;
    border: none;
    background: transparent;
    padding: 0.75rem 1rem;
    text-align: left;
    font-size: 0.95rem;
    cursor: pointer;
  }
  .search-result:hover, .search-result:focus { background: #f7f1ed; outline: none; }
  .search-result strong { color: #5e524b; }
  .search-result small { color: #9b9087; }

  .eligibility-message {
    margin-top: 1rem;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    font-size: 0.95rem;
    line-height: 1.5;
    border: 1px solid transparent;
  }
  .eligibility-message[data-status="checking"] { background: #f1ede9; border-color: #e0d6cd; color: #5e524b; }
  .eligibility-message[data-status="ok"]       { background: rgba(73,160,120,.12); border-color: rgba(73,160,120,.35); color:#2e6b4f; }
  .eligibility-message[data-status="info"]     { background: rgba(255,193,7,.12); border-color: rgba(255,193,7,.35); color:#8a6d00; }
  .eligibility-message[data-status="error"]    { background: rgba(220,53,69,.12); border-color: rgba(220,53,69,.35); color:#a12635; }

  .family-summary { margin-top: 1.5rem; padding: 1rem; border-radius: 10px; background: #f7f1ed; color: #5e524b; }
  .family-summary h3 { margin: 0 0 .5rem; font-size: 1.1rem; }
  .family-summary p { margin: .25rem 0; }
  .family-summary-members { margin-top: .75rem; font-size: .9rem; color: #5e524b; }

  .submission-lock { margin-top: 1rem; padding: 1rem; border-radius: 8px; background: rgba(0, 123, 255, 0.12); border: 1px solid rgba(0, 123, 255, 0.25); color: #084298; }
  
  .form-details { margin-top: 1.5rem; }
  .form-details label { display: block; margin-top: 1rem; font-weight: 600; color: #5e524b; }
  .form-details textarea {
    width: 100%;
    min-height: 80px;
    padding: 0.75rem;
    margin-top: 0.25rem;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-family: 'Inter', sans-serif;
    resize: vertical;
  }

  .attendee-selector { margin-top: 1.5rem; border-top: 1px solid #eee; padding-top: 1rem; }
  .attendee-instructions { margin: 0 0 .75rem; font-size: .9rem; color: #7a6d64; }
  .attendance-rows { display: grid; gap: .5rem; }

  .attendee-row {
    display: flex; align-items: center; justify-content: space-between; gap: .75rem;
    border: 1px solid #eee; border-radius: 8px; padding: .5rem .75rem; background: #faf9f8;
  }
  .attendee-name { font-weight: 600; color: #5e524b; }
  .attendee-select { border: 1px solid #ccc; border-radius: 8px; padding: .4rem .6rem; background: #fff; }

  .rsvp-form button[type="submit"] {
    margin-top: 1.5rem;
    width: 100%;
    background-color: #c9bab0;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 0.75rem;
    font-size: 1rem;
    cursor: pointer;
    transition: background 0.3s;
  }
  .rsvp-form button[type="submit"]:hover { background-color: #b3a69c; }
  .rsvp-form button[type="submit"]:disabled { background-color: #e0d6cd; cursor: not-allowed; }

  .is-hidden { display: none !important; }
</style>

<div class="rsvp-layout">
  <!-- Admin override names (can submit for any family). Separate with | -->
  <div class="rsvp-form" data-owner-names="Patricia Example|Mark Example">
    <form id="rsvp-form" autocomplete="off">
      <div class="guest-search">
        <label for="guest-search">Find your invitation (type the LEAD name)</label>
        <div class="guest-search-field">
          <input type="search" id="guest-search" placeholder="e.g., Mariel Jabillo" autocomplete="off">
          <button type="button" id="guest-search-button" aria-label="Search for your invitation">Search</button>
        </div>
        <div class="search-results" id="guest-results" role="listbox" aria-label="Matches"></div>
      </div>

      <div class="eligibility-message" id="eligibility-message" data-status="checking">
        Type the family lead’s full name, then tap Search.
      </div>

      <div class="family-summary is-hidden" id="family-summary">
        <h3 id="family-summary-title"></h3>
        <p id="family-summary-count"></p>
        <div class="family-summary-members" id="family-summary-members"></div>
      </div>

      <div class="submission-lock is-hidden" id="submission-lock">
        We have already received this family's RSVP. For any changes in attendance, please contact the couple.
      </div>

      <div class="form-details is-hidden" id="form-details">
        <label for="notes">Notes (optional)</label>
        <textarea id="notes" placeholder="Dietary needs, seating, etc."></textarea>

        <div class="attendee-selector">
          <p class="attendee-instructions">Confirm attendance for each member below.</p>
          <div class="attendance-rows" id="attendance-rows"></div>
        </div>

        <button type="submit" id="rsvp-submit" disabled>Send RSVP</button>
      </div>
    </form>
  </div>
</div>

<script>
(() => {
  /******** CONFIG ********/
  const API_BASE = 'https://script.google.com/macros/s/AKfycbx_HyBsd8mrLj4yi2O4XrKpYl8B2FDQMW2l9lL9xgLrPXObo-0r6da10rwamir_hNEo/exec'; // e.g. https://script.google.com/macros/s/XXXX/exec
  const CASE_INSENSITIVE = true;

  /******** Elements ********/
  const formWrapper   = document.querySelector('.rsvp-form');
  const form          = document.getElementById('rsvp-form');
  const searchInput   = document.getElementById('guest-search');
  const searchButton  = document.getElementById('guest-search-button');
  const resultsBox    = document.getElementById('guest-results'); // kept for UI parity (optional)
  const statusBanner  = document.getElementById('eligibility-message');
  const famBox        = document.getElementById('family-summary');
  const famTitle      = document.getElementById('family-summary-title');
  const famCount      = document.getElementById('family-summary-count');
  const famMembers    = document.getElementById('family-summary-members');
  const lockBanner    = document.getElementById('submission-lock');
  const formDetails   = document.getElementById('form-details');
  const notesField    = document.getElementById('notes');
  const rowsContainer = document.getElementById('attendance-rows');
  const submitBtn     = document.getElementById('rsvp-submit');
  const defaultSubmitLabel = submitBtn.textContent;
  const updateSubmitLabel = 'Update RSVP';

  /******** State ********/
  let currentFamily = null;
  const ownerOverrides = new Set();

  // pick up admin names from data-owner-names and optional global override list
  (function loadOwnerOverrides() {
    if (formWrapper && formWrapper.dataset.ownerNames) {
      formWrapper.dataset.ownerNames.split('|').forEach(n => {
        const v = String(n || '').trim().toLowerCase();
        if (v) ownerOverrides.add(v);
      });
    }
    if (Array.isArray(window.RSVP_OWNER_OVERRIDES)) {
      window.RSVP_OWNER_OVERRIDES.forEach(n => {
        const v = String(n || '').trim().toLowerCase();
        if (v) ownerOverrides.add(v);
      });
    }
  })();

  /******** Utils ********/
  const norm = s => String(s || '').trim();
  const normName = s => norm(s).toLowerCase();

  function setBanner(kind, msg) {
    statusBanner.dataset.status = kind;
    statusBanner.textContent = msg;
  }

  function showLock(msg) {
    lockBanner.classList.remove('is-hidden');
    lockBanner.textContent = msg || 'This family’s RSVP is already submitted.';
    formDetails.classList.add('is-hidden');
    submitBtn.disabled = true;
  }
  function hideLock() { lockBanner.classList.add('is-hidden'); }

  function setFormEnabled(enabled) { submitBtn.disabled = !enabled; }

  function showFamily(f) {
    famBox.classList.remove('is-hidden');
    famTitle.textContent = `${f.leadName} — Family ID: ${f.familyId}`;
    const members = f.members || [];
    famCount.textContent = `Members on this invitation: ${members.length}`;
    famMembers.textContent = members.join(', ');
  }
  function hideFamily() {
    famBox.classList.add('is-hidden');
    famTitle.textContent = '';
    famCount.textContent = '';
    famMembers.textContent = '';
  }

  function interpretAttendance(entry) {
    if (!entry) return null;
    if (typeof entry.attending === 'boolean') {
      return entry.attending;
    }
    const text = (entry.status || entry.attendance || entry.response || entry.answer || '').toString().toLowerCase();
    if (!text) return null;
    if (['yes', 'attending', 'attend', 'true', '1'].includes(text)) return true;
    if (['no', 'not attending', 'decline', 'declined', 'false', '0'].includes(text)) return false;
    return null;
  }

  function getExistingStatuses(family) {
    if (!family) return [];
    const normalizeObjectStatuses = (obj) => {
      if (!obj || typeof obj !== 'object' || Array.isArray(obj)) return null;
      return Object.entries(obj).map(([name, attending]) => ({ name, attending }));
    };
    if (Array.isArray(family.statuses)) return family.statuses;
    const objectStatuses = normalizeObjectStatuses(family.statuses);
    if (objectStatuses) return objectStatuses;
    if (Array.isArray(family.responses)) return family.responses;
    const objectResponses = normalizeObjectStatuses(family.responses);
    if (objectResponses) return objectResponses;
    if (family.lastSubmission) {
      if (Array.isArray(family.lastSubmission.statuses)) {
        return family.lastSubmission.statuses;
      }
      const normalized = normalizeObjectStatuses(family.lastSubmission.statuses);
      if (normalized) return normalized;
    }
    if (family.submission) {
      if (Array.isArray(family.submission.statuses)) {
        return family.submission.statuses;
      }
      const normalizedSubmission = normalizeObjectStatuses(family.submission.statuses);
      if (normalizedSubmission) return normalizedSubmission;
    }
    return [];
  }

  function getExistingNotes(family) {
    if (!family) return '';
    if (typeof family.notes === 'string') return family.notes;
    if (family.lastSubmission && typeof family.lastSubmission.notes === 'string') {
      return family.lastSubmission.notes;
    }
    if (family.submission && typeof family.submission.notes === 'string') {
      return family.submission.notes;
    }
    return '';
  }

  function renderMemberRows(family, existingStatuses = []) {
    rowsContainer.innerHTML = '';
    const statusMap = new Map();
    existingStatuses.forEach(entry => {
      const key = normName(entry.name || entry.memberName || entry.member);
      if (!key) return;
      const interpreted = interpretAttendance(entry);
      if (interpreted == null) return;
      statusMap.set(key, interpreted);
    });

    (family.members || []).forEach(name => {
      const row = document.createElement('div');
      row.className = 'attendee-row';

      const left = document.createElement('div');
      left.className = 'attendee-name';
      left.textContent = name;

      const sel = document.createElement('select');
      sel.className = 'attendee-select';
      sel.innerHTML = `
        <option value="yes">Attending</option>
        <option value="no">Not attending</option>
      `;

      row.dataset.name = name;
      const mapped = statusMap.get(normName(name));
      if (mapped === false) sel.value = 'no';
      if (mapped === true) sel.value = 'yes';
      row.append(left, sel);
      rowsContainer.appendChild(row);
    });
  }

  async function apiGetFamily(lead) {
    const url = API_BASE + `?action=getFamily&lead=${encodeURIComponent(lead)}`;
    const res = await fetch(url, { method: 'GET' });
    return res.json();
  }

  async function apiSubmit(payload) {
    const res = await fetch(API_BASE, {
      method: 'POST',
      body: JSON.stringify(payload)
    });
    return res.json();
  }

  function canSubmitFor(family, typedName) {
    const isLead = CASE_INSENSITIVE
      ? normName(family.leadName) === normName(typedName)
      : norm(family.leadName) === norm(typedName);
    return isLead || ownerOverrides.has(normName(typedName));
  }

  function collectStatuses() {
    return [...rowsContainer.children].map(row => {
      const name = row.dataset.name;
      const attending = row.querySelector('select').value === 'yes';
      return { name, attending };
    });
  }

  /******** Search + Load ********/
  async function handleSearch(typed) {
    const q = norm(typed);
    if (!q) {
      setBanner('checking', 'Type the family lead’s full name, then tap Search.');
      hideFamily(); hideLock(); setFormEnabled(false);
      formDetails.classList.add('is-hidden');
      submitBtn.textContent = defaultSubmitLabel;
      notesField.value = '';
      currentFamily = null;
      return;
    }

    setBanner('checking', 'Looking up your family invitation…');
    hideLock(); setFormEnabled(false); formDetails.classList.add('is-hidden');

    try {
      const resp = await apiGetFamily(q);
      if (!resp.ok) {
        setBanner('error', resp.error || 'Lead not found. Please check spelling or contact the couple.');
        hideFamily(); currentFamily = null;
        return;
      }

      const fam = resp.data || {};
      currentFamily = fam;
      showFamily(fam);

      if (!canSubmitFor(fam, q)) {
        setBanner('info', `Only the designated family lead (${fam.leadName}) can submit the RSVP.`);
        formDetails.classList.add('is-hidden');
        return;
      }

      const existingStatuses = getExistingStatuses(fam);
      const existingNotes = getExistingNotes(fam);

      renderMemberRows(fam, existingStatuses);
      notesField.value = existingNotes;
      currentFamily.statuses = existingStatuses;
      currentFamily.notes = existingNotes;
      formDetails.classList.remove('is-hidden');
      submitBtn.textContent = fam.submitted ? updateSubmitLabel : defaultSubmitLabel;
      const welcomeText = fam.submitted
        ? `Welcome back ${fam.leadName}! We loaded your previous RSVP—update any details below.`
        : `Welcome ${fam.leadName}! Please confirm each member below.`;
      setBanner('ok', welcomeText);
      setFormEnabled(true);
    } catch (err) {
      console.error(err);
      setBanner('error', 'Something went wrong while loading. Please try again or contact the couple.');
      hideFamily(); hideLock();
      currentFamily = null;
    }
  }

  // Press Enter to search; blur also triggers.
  searchInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') { e.preventDefault(); handleSearch(searchInput.value); }
  });
  searchButton?.addEventListener('click', () => handleSearch(searchInput.value));
  searchInput.addEventListener('change', () => handleSearch(searchInput.value));
  // optional: hide suggestions panel if present
  searchInput.addEventListener('blur', () => setTimeout(() => resultsBox?.classList?.remove('is-visible'), 150));

  /******** Submit ********/
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!currentFamily) { setBanner('error', 'Please look up the lead name first.'); return; }

    const typedName = norm(searchInput.value);
    if (!canSubmitFor(currentFamily, typedName)) {
      setBanner('error', `Only ${currentFamily.leadName} (or an admin) can submit this RSVP.`);
      return;
    }

    const statuses = collectStatuses();
    if (!statuses.length) { setBanner('error', 'No members to submit.'); return; }

    submitBtn.disabled = true;
    try {
      const payload = {
        familyId: currentFamily.familyId,
        leadName: currentFamily.leadName,
        notes: norm(notesField.value),
        statuses
      };
      const resp = await apiSubmit(payload);

      if (!resp.ok) {
        if (resp.locked) {
          showLock(resp.message || 'This family’s RSVP is already submitted.');
          setBanner('info', 'RSVP already submitted.');
        } else {
          setBanner('error', resp.error || 'Unable to submit. Please try again.');
          submitBtn.disabled = false;
        }
        return;
      }

      setBanner('ok', 'RSVP saved! You can return here anytime to make updates.');
      submitBtn.disabled = false;
      setFormEnabled(true);
      submitBtn.textContent = updateSubmitLabel;
      hideLock();
      currentFamily.submitted = true;
      currentFamily.statuses = statuses;
      const normalizedNotes = norm(notesField.value);
      currentFamily.notes = normalizedNotes;
      notesField.value = normalizedNotes;
    } catch (err) {
      console.error(err);
      setBanner('error', 'Submission failed. Please try again or contact the couple.');
      submitBtn.disabled = false;
    }
  });
})();
</script>
