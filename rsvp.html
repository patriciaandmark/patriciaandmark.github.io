<h2>RSVP</h2>
<style>
  :root {
    --font-heading: 'Libre Baskerville', serif;
    --font-body: 'Libre Baskerville', serif;
    --color-background: #f9f4f0;
    --color-surface: #ffffff;
    --color-heading: #5e524b;
    --color-text: #8c7a72;
    --color-accent: #d8c3b4;
    --color-muted: rgba(94, 82, 75, 0.35);
  }

  .rsvp-layout {
    display: grid;
    gap: 2rem;
    margin: 2rem auto;
    max-width: 900px;
    grid-template-columns: 1fr;
  }

  .rsvp-form {
    background: var(--color-surface);
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(94, 82, 75, 0.08);
    text-align: left;
    font-family: var(--font-body);
  }

  .rsvp-intro {
    margin: 0;
    color: var(--color-text);
  }

  .eligibility-message {
    margin-top: 1rem;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    font-size: 0.95rem;
    line-height: 1.5;
    border: 1px solid transparent;
    font-family: var(--font-body);
  }
  .eligibility-message[data-status="checking"] { background: #f1ede9; border-color: #e0d6cd; color: var(--color-heading); }
  .eligibility-message[data-status="ok"]       { background: rgba(216, 195, 180, 0.2); border-color: rgba(216, 195, 180, 0.45); color: var(--color-heading); }
  .eligibility-message[data-status="info"]     { background: rgba(249, 238, 226, 0.8); border-color: rgba(216, 195, 180, 0.4); color: var(--color-text); }
  .eligibility-message[data-status="error"]    { background: rgba(221, 120, 116, 0.12); border-color: rgba(221, 120, 116, 0.35); color: #a45a51; }

  .family-summary { margin-top: 1.5rem; padding: 1rem; border-radius: 10px; background: rgba(249, 238, 226, 0.65); color: var(--color-heading); }
  .family-summary h3 { margin: 0 0 .5rem; font-size: 1.1rem; font-family: var(--font-heading); text-transform: uppercase; letter-spacing: 0.08em; }
  .family-summary p { margin: .25rem 0; }
  .family-summary-code { font-size: 0.9rem; color: var(--color-text); }
  .family-summary-members { margin-top: .75rem; font-size: .9rem; color: var(--color-text); }

  .last-updated { margin-top: 1rem; font-size: 0.9rem; color: var(--color-text); }

  .form-details { margin-top: 1.5rem; }
  .form-details label { display: block; margin-top: 1rem; font-weight: 600; color: var(--color-heading); font-family: var(--font-heading); letter-spacing: 0.05em; }
  .form-details textarea {
    width: 100%;
    min-height: 80px;
    padding: 0.75rem;
    margin-top: 0.25rem;
    border-radius: 8px;
    border: 1px solid var(--color-muted);
    font-family: var(--font-body);
    color: var(--color-heading);
    background: rgba(255, 255, 255, 0.9);
    resize: vertical;
  }

  .attendee-selector { margin-top: 1.5rem; border-top: 1px solid #eee; padding-top: 1rem; }
  .attendee-instructions { margin: 0 0 .75rem; font-size: .9rem; color: var(--color-text); }
  .attendance-rows { display: grid; gap: .5rem; }

  .attendee-row {
    display: flex; align-items: center; justify-content: space-between; gap: .75rem;
    border: 1px solid rgba(94, 82, 75, 0.15); border-radius: 8px; padding: .5rem .75rem; background: rgba(255, 255, 255, 0.95);
  }
  .attendee-name { font-weight: 600; color: var(--color-heading); font-family: var(--font-heading); }
  .attendee-select { border: 1px solid var(--color-muted); border-radius: 8px; padding: .4rem .6rem; background: rgba(255, 255, 255, 0.95); font-family: var(--font-body); color: var(--color-heading); }

  .rsvp-form button[type="submit"] {
    margin-top: 1.5rem;
    width: 100%;
    background-color: var(--color-accent);
    color: var(--color-heading);
    border: none;
    border-radius: 8px;
    padding: 0.75rem;
    font-size: 1rem;
    cursor: pointer;
    transition: background 0.3s, transform 0.2s;
    font-family: var(--font-heading);
  }
  .rsvp-form button[type="submit"]:hover { background-color: #cbb4a5; transform: translateY(-1px); }
  .rsvp-form button[type="submit"]:disabled { background-color: rgba(216, 195, 180, 0.6); cursor: not-allowed; color: rgba(94, 82, 75, 0.65); }

  .is-hidden { display: none !important; }

  .dialog-overlay {
    position: fixed;
    inset: 0;
    background: rgba(249, 244, 240, 0.65);
    backdrop-filter: blur(6px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
  }

  .dialog-card {
    background: var(--color-surface);
    border-radius: 16px;
    padding: 2rem 2.5rem;
    box-shadow: 0 12px 28px rgba(94, 82, 75, 0.18);
    text-align: center;
    max-width: 420px;
    width: min(90%, 420px);
  }

  .dialog-card h3 {
    margin: 0 0 0.75rem;
  }

  .dialog-card p {
    margin: 0 0 1.5rem;
  }

  .dialog-card button {
    background-color: var(--color-accent);
    border: none;
    border-radius: 8px;
    padding: 0.6rem 1.5rem;
    font-family: var(--font-heading);
    cursor: pointer;
  }
</style>

<div class="rsvp-layout">
  <div class="rsvp-form">
    <form id="rsvp-form" autocomplete="off">
      <p class="rsvp-intro" id="intro-text">
        Enter your invite code on the welcome page to manage your RSVP.
      </p>

      <div class="eligibility-message" id="eligibility-message" data-status="checking">
        Waiting for a invite code…
      </div>

      <div class="family-summary is-hidden" id="family-summary">
        <h3 id="family-summary-title"></h3>
        <p id="family-summary-count"></p>
        <p id="family-summary-code" class="family-summary-code"></p>
        <div class="family-summary-members" id="family-summary-members"></div>
      </div>

      <div class="last-updated is-hidden" id="last-updated"></div>

      <div class="form-details is-hidden" id="form-details">
        <div class="attendee-selector">
          <p class="attendee-instructions">Confirm attendance for each member below.</p>
          <div class="attendance-rows" id="attendance-rows"></div>
        </div>

        <label for="notes">Notes (optional)</label>
        <textarea id="notes" placeholder="Dietary needs, allergies, etc."></textarea>

        <button type="submit" id="rsvp-submit" disabled>Save RSVP</button>
      </div>
    </form>
  </div>
</div>

<div class="dialog-overlay is-hidden" id="rsvp-dialog" role="dialog" aria-modal="true" aria-labelledby="dialog-title">
  <div class="dialog-card">
    <h3 id="dialog-title">RSVP Status</h3>
    <p id="dialog-message"></p>
    <button type="button" id="dialog-ok">OK</button>
  </div>
</div>

<script>
(() => {
  const API_BASE = 'https://script.google.com/macros/s/AKfycbx_HyBsd8mrLj4yi2O4XrKpYl8B2FDQMW2l9lL9xgLrPXObo-0r6da10rwamir_hNEo/exec';

  const introText     = document.getElementById('intro-text');
  const form          = document.getElementById('rsvp-form');
  const statusBanner  = document.getElementById('eligibility-message');
  const famBox        = document.getElementById('family-summary');
  const famTitle      = document.getElementById('family-summary-title');
  const famCount      = document.getElementById('family-summary-count');
  const famCode       = document.getElementById('family-summary-code');
  const famMembers    = document.getElementById('family-summary-members');
  const lastUpdated   = document.getElementById('last-updated');
  const formDetails   = document.getElementById('form-details');
  const notesField    = document.getElementById('notes');
  const rowsContainer = document.getElementById('attendance-rows');
  const submitBtn     = document.getElementById('rsvp-submit');
  const dialog        = document.getElementById('rsvp-dialog');
  const dialogTitle   = document.getElementById('dialog-title');
  const dialogMessage = document.getElementById('dialog-message');
  const dialogOk      = document.getElementById('dialog-ok');

  let currentFamily = null;
  let familyCode = null;
  let initialised = false;
  let dialogAction = null;
  let redirectTimer = null;

  const norm = (s) => String(s || '').trim();
  const normName = (s) => norm(s).toLowerCase();

  function setBanner(kind, msg) {
    statusBanner.dataset.status = kind;
    statusBanner.textContent = msg;
  }

  function setFormEnabled(enabled) {
    submitBtn.disabled = !enabled;
  }

  function showFamily(f) {
    famBox.classList.remove('is-hidden');
    famTitle.textContent = `Hello ${f.leadName}!`;
    const members = Array.isArray(f.members) ? f.members : [];
    famCount.textContent = `Members on this invitation: ${members.length}`;
    famMembers.textContent = members.join(', ');
    // famCode.textContent = `Family code: ${familyCode}`;
  }

  function hideFamily() {
    famBox.classList.add('is-hidden');
    famTitle.textContent = '';
    famCount.textContent = '';
    famMembers.textContent = '';
    famCode.textContent = '';
  }

  function showLastUpdated(date) {
    if (!date) {
      lastUpdated.classList.add('is-hidden');
      lastUpdated.textContent = '';
      return;
    }
    const dt = date instanceof Date ? date : new Date(date);
    lastUpdated.textContent = `Last updated: ${dt.toLocaleString()}`;
    lastUpdated.classList.remove('is-hidden');
  }

  function renderMemberRows(family) {
    rowsContainer.innerHTML = '';
    (family.members || []).forEach((name) => {
      const row = document.createElement('div');
      row.className = 'attendee-row';

      const left = document.createElement('div');
      left.className = 'attendee-name';
      left.textContent = name;

      const sel = document.createElement('select');
      sel.className = 'attendee-select';
      sel.innerHTML = `
        <option value="" selected>Select...</option>
        <option value="yes">Attending</option>
        <option value="no">Not attending</option>
      `;

      row.dataset.name = name;
      row.append(left, sel);
      rowsContainer.appendChild(row);
    });
  }

  function applyStatuses(statuses) {
    if (!Array.isArray(statuses)) return;
    const map = new Map();
    statuses.forEach((entry) => {
      if (!entry || typeof entry.name !== 'string') return;
      map.set(normName(entry.name), Boolean(entry.attending));
    });

    [...rowsContainer.children].forEach((row) => {
      const key = normName(row.dataset.name);
      if (!map.has(key)) return;
      row.querySelector('select').value = map.get(key) ? 'yes' : 'no';
    });
  }

  function collectStatuses() {
    return [...rowsContainer.children].map((row) => {
      const name = row.dataset.name;
      const choice = row.querySelector('select').value;
      return { name, attending: choice === 'yes', choice };
    });
  }

  function showDialog({ title, message, confirmText = 'OK', showButton = true, onConfirm = null }) {
    dialogTitle.textContent = title;
    dialogMessage.textContent = message;
    dialogOk.textContent = confirmText;
    dialogOk.classList.toggle('is-hidden', !showButton);
    dialogAction = onConfirm;
    dialog.classList.remove('is-hidden');
  }

  function hideDialog() {
    dialog.classList.add('is-hidden');
    dialogAction = null;
  }

  function goToFaq() {
    if (typeof window.navigateTo === 'function') {
      window.navigateTo('faq');
    } else {
      window.location.href = 'main.html?page=faq';
    }
  }

  function hydrateFamily(family, { fromCache = false } = {}) {
    if (!family) return;
    currentFamily = family;
    renderMemberRows(family);
    applyStatuses(family.statuses || []);
    notesField.value = norm(family.notes);
    showFamily(family);
    showLastUpdated(family.submittedAt ? new Date(family.submittedAt) : null);

    if (family.submittedAt && !fromCache) {
      setBanner('info', 'Your previous responses are loaded. Update anything below and save to make changes.');
    } else if (!fromCache) {
      setBanner('ok', `Welcome ${family.leadName}! Please confirm each member below.`);
    }

    formDetails.classList.remove('is-hidden');
    setFormEnabled(true);
  }

  async function fetchFamily(options = {}) {
    if (!familyCode) return;
    const message = Object.prototype.hasOwnProperty.call(options, 'message') ? options.message : 'Loading your RSVP…';
    setFormEnabled(false);
    if (message !== null) {
      setBanner('checking', message || 'Loading your RSVP…');
    }

    try {
      const res = await fetch(`${API_BASE}?action=getFamilyByCode&code=${encodeURIComponent(familyCode)}`);
      const payload = await res.json();

      if (!payload.ok) {
        setBanner('error', payload.error || 'We could not find that invite code.');
        hideFamily();
        formDetails.classList.add('is-hidden');
        currentFamily = null;
        setFormEnabled(false);
        return;
      }

      const family = payload.data || {};
      hydrateFamily(family);
      sessionStorage.setItem('RSVP_FAMILY_CACHE', JSON.stringify(family));
    } catch (err) {
      console.error(err);
      setBanner('error', 'Something went wrong while loading. Please try again.');
      setFormEnabled(true);
    }
  }

  function init() {
    if (initialised) return;
    initialised = true;

    familyCode = sessionStorage.getItem('RSVP_FAMILY_CODE');
    const cached = sessionStorage.getItem('RSVP_FAMILY_CACHE');

    if (!familyCode) {
      setBanner('error', 'Please return to the welcome page and enter your invite code to RSVP.');
      introText.textContent = 'Enter your invite code on the welcome page to manage your RSVP.';
      setFormEnabled(false);
      hideFamily();
      formDetails.classList.add('is-hidden');
      return;
    }

    introText.textContent = 'Review your RSVP details below, make any updates, and save when you are ready.';

    if (cached) {
      try {
        const parsed = JSON.parse(cached);
        hydrateFamily(parsed, { fromCache: true });
        setBanner('info', 'Showing the most recent details saved on this device…');
      } catch (err) {
        console.warn('Unable to parse cached family data', err);
      }
    }

    const message = cached ? 'Refreshing your RSVP…' : 'Loading your RSVP…';
    fetchFamily({ message });
  }

  form.addEventListener('submit', async (event) => {
    event.preventDefault();
    if (!currentFamily || !familyCode) {
      setBanner('error', 'Please enter your invite code on the welcome page to begin.');
      return;
    }

    const rawStatuses = collectStatuses();
    const missing = rawStatuses.find((status) => status.choice === '');
    if (missing) {
      setBanner('error', 'Please select attending or not attending for each guest.');
      return;
    }

    const statuses = rawStatuses.map(({ name, attending }) => ({ name, attending }));
    if (!statuses.length) {
      setBanner('error', 'We could not find any members on this invitation.');
      return;
    }

    const payload = {
      familyId: currentFamily.familyId,
      code: familyCode,
      notes: norm(notesField.value),
      statuses,
    };

    setFormEnabled(false);
    setBanner('checking', 'Saving your RSVP…');
    showDialog({
      title: 'Saving your RSVP',
      message: 'Please wait while we save your updates.',
      showButton: false,
    });

    try {
      const res = await fetch(API_BASE, {
        method: 'POST',
        mode: 'cors',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify(payload),
      });

      if (!res.ok) {
        throw new Error(`Request failed with status ${res.status}`);
      }

      const text = await res.text();
      let data;
      try {
        data = JSON.parse(text);
      } catch (parseErr) {
        throw new Error('Received an invalid response from the server.');
      }

      if (!data.ok) {
        setBanner('error', data.error || 'Unable to save your RSVP right now.');
        setFormEnabled(true);
        showDialog({
          title: 'RSVP Failed',
          message: data.error || 'We could not save your RSVP. Please try again.',
        });
        return;
      }

      setBanner('ok', 'Thank you! Your RSVP has been saved.');
      await fetchFamily({ message: null });
      showDialog({
        title: 'RSVP Saved',
        message: 'Your RSVP has been saved successfully. Redirecting to the FAQ…',
        showButton: false,
      });
      if (redirectTimer) {
        clearTimeout(redirectTimer);
      }
      redirectTimer = setTimeout(() => {
        goToFaq();
      }, 1600);
    } catch (err) {
      console.error(err);
      setBanner('error', 'Submission failed. Please try again.');
      setFormEnabled(true);
      showDialog({
        title: 'RSVP Failed',
        message: 'We could not save your RSVP. Please try again.',
        onConfirm: () => {},
      });
    }
  });

  dialogOk.addEventListener('click', () => {
    hideDialog();
    if (typeof dialogAction === 'function') {
      dialogAction();
    }
  });

  init();
})();
</script>
