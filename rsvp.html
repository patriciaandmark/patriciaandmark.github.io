<h2>RSVP</h2>
<style>
  .rsvp-layout {
    display: grid;
    gap: 2rem;
    margin: 2rem auto;
    max-width: 900px;
    grid-template-columns: 1fr;
  }

  .rsvp-form {
    background: #fff;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.05);
    text-align: left;
  }

  .rsvp-intro {
    margin: 0;
    color: #7a6d64;
  }

  .eligibility-message {
    margin-top: 1rem;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    font-size: 0.95rem;
    line-height: 1.5;
    border: 1px solid transparent;
  }
  .eligibility-message[data-status="checking"] { background: #f1ede9; border-color: #e0d6cd; color: #5e524b; }
  .eligibility-message[data-status="ok"]       { background: rgba(73,160,120,.12); border-color: rgba(73,160,120,.35); color:#2e6b4f; }
  .eligibility-message[data-status="info"]     { background: rgba(255,193,7,.12); border-color: rgba(255,193,7,.35); color:#8a6d00; }
  .eligibility-message[data-status="error"]    { background: rgba(220,53,69,.12); border-color: rgba(220,53,69,.35); color:#a12635; }

  .family-summary { margin-top: 1.5rem; padding: 1rem; border-radius: 10px; background: #f7f1ed; color: #5e524b; }
  .family-summary h3 { margin: 0 0 .5rem; font-size: 1.1rem; }
  .family-summary p { margin: .25rem 0; }
  .family-summary-code { font-size: 0.9rem; color: #7a6d64; }
  .family-summary-members { margin-top: .75rem; font-size: .9rem; color: #5e524b; }

  .last-updated { margin-top: 1rem; font-size: 0.9rem; color: #7a6d64; }

  .form-details { margin-top: 1.5rem; }
  .form-details label { display: block; margin-top: 1rem; font-weight: 600; color: #5e524b; }
  .form-details textarea {
    width: 100%;
    min-height: 80px;
    padding: 0.75rem;
    margin-top: 0.25rem;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-family: 'Inter', sans-serif;
    resize: vertical;
  }

  .attendee-selector { margin-top: 1.5rem; border-top: 1px solid #eee; padding-top: 1rem; }
  .attendee-instructions { margin: 0 0 .75rem; font-size: .9rem; color: #7a6d64; }
  .attendance-rows { display: grid; gap: .5rem; }

  .attendee-row {
    display: flex; align-items: center; justify-content: space-between; gap: .75rem;
    border: 1px solid #eee; border-radius: 8px; padding: .5rem .75rem; background: #faf9f8;
  }
  .attendee-name { font-weight: 600; color: #5e524b; }
  .attendee-select { border: 1px solid #ccc; border-radius: 8px; padding: .4rem .6rem; background: #fff; }

  .rsvp-form button[type="submit"] {
    margin-top: 1.5rem;
    width: 100%;
    background-color: #c9bab0;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 0.75rem;
    font-size: 1rem;
    cursor: pointer;
    transition: background 0.3s;
  }
  .rsvp-form button[type="submit"]:hover { background-color: #b3a69c; }
  .rsvp-form button[type="submit"]:disabled { background-color: #e0d6cd; cursor: not-allowed; }

  .is-hidden { display: none !important; }
</style>

<div class="rsvp-layout">
  <div class="rsvp-form">
    <form id="rsvp-form" autocomplete="off">
      <p class="rsvp-intro" id="intro-text">
        Enter your invite code on the welcome page to manage your RSVP.
      </p>

      <div class="eligibility-message" id="eligibility-message" data-status="checking">
        Waiting for a invite code…
      </div>

      <div class="family-summary is-hidden" id="family-summary">
        <h3 id="family-summary-title"></h3>
        <p id="family-summary-count"></p>
        <p id="family-summary-code" class="family-summary-code"></p>
        <div class="family-summary-members" id="family-summary-members"></div>
      </div>

      <div class="last-updated is-hidden" id="last-updated"></div>

      <div class="form-details is-hidden" id="form-details">
        <label for="notes">Notes (optional)</label>
        <textarea id="notes" placeholder="Dietary needs, seating, etc."></textarea>

        <div class="attendee-selector">
          <p class="attendee-instructions">Confirm attendance for each member below.</p>
          <div class="attendance-rows" id="attendance-rows"></div>
        </div>

        <button type="submit" id="rsvp-submit" disabled>Save RSVP</button>
      </div>
    </form>
  </div>
</div>

<script>
(() => {
  const API_BASE = 'https://script.google.com/macros/s/AKfycbx_HyBsd8mrLj4yi2O4XrKpYl8B2FDQMW2l9lL9xgLrPXObo-0r6da10rwamir_hNEo/exec';

  const introText     = document.getElementById('intro-text');
  const form          = document.getElementById('rsvp-form');
  const statusBanner  = document.getElementById('eligibility-message');
  const famBox        = document.getElementById('family-summary');
  const famTitle      = document.getElementById('family-summary-title');
  const famCount      = document.getElementById('family-summary-count');
  const famCode       = document.getElementById('family-summary-code');
  const famMembers    = document.getElementById('family-summary-members');
  const lastUpdated   = document.getElementById('last-updated');
  const formDetails   = document.getElementById('form-details');
  const notesField    = document.getElementById('notes');
  const rowsContainer = document.getElementById('attendance-rows');
  const submitBtn     = document.getElementById('rsvp-submit');

  let currentFamily = null;
  let familyCode = null;
  let initialised = false;

  const norm = (s) => String(s || '').trim();
  const normName = (s) => norm(s).toLowerCase();

  function setBanner(kind, msg) {
    statusBanner.dataset.status = kind;
    statusBanner.textContent = msg;
  }

  function setFormEnabled(enabled) {
    submitBtn.disabled = !enabled;
  }

  function showFamily(f) {
    famBox.classList.remove('is-hidden');
    famTitle.textContent = `Hello ${f.leadName}!`;
    const members = Array.isArray(f.members) ? f.members : [];
    famCount.textContent = `Members on this invitation: ${members.length}`;
    famMembers.textContent = members.join(', ');
    // famCode.textContent = `Family code: ${familyCode}`;
  }

  function hideFamily() {
    famBox.classList.add('is-hidden');
    famTitle.textContent = '';
    famCount.textContent = '';
    famMembers.textContent = '';
    famCode.textContent = '';
  }

  function showLastUpdated(date) {
    if (!date) {
      lastUpdated.classList.add('is-hidden');
      lastUpdated.textContent = '';
      return;
    }
    const dt = date instanceof Date ? date : new Date(date);
    lastUpdated.textContent = `Last updated: ${dt.toLocaleString()}`;
    lastUpdated.classList.remove('is-hidden');
  }

  function renderMemberRows(family) {
    rowsContainer.innerHTML = '';
    (family.members || []).forEach((name) => {
      const row = document.createElement('div');
      row.className = 'attendee-row';

      const left = document.createElement('div');
      left.className = 'attendee-name';
      left.textContent = name;

      const sel = document.createElement('select');
      sel.className = 'attendee-select';
      sel.innerHTML = `
        <option value="yes">Attending</option>
        <option value="no">Not attending</option>
      `;

      row.dataset.name = name;
      row.append(left, sel);
      rowsContainer.appendChild(row);
    });
  }

  function applyStatuses(statuses) {
    if (!Array.isArray(statuses)) return;
    const map = new Map();
    statuses.forEach((entry) => {
      if (!entry || typeof entry.name !== 'string') return;
      map.set(normName(entry.name), Boolean(entry.attending));
    });

    [...rowsContainer.children].forEach((row) => {
      const key = normName(row.dataset.name);
      if (!map.has(key)) return;
      row.querySelector('select').value = map.get(key) ? 'yes' : 'no';
    });
  }

  function collectStatuses() {
    return [...rowsContainer.children].map((row) => {
      const name = row.dataset.name;
      const attending = row.querySelector('select').value === 'yes';
      return { name, attending };
    });
  }

  function hydrateFamily(family, { fromCache = false } = {}) {
    if (!family) return;
    currentFamily = family;
    renderMemberRows(family);
    applyStatuses(family.statuses || []);
    notesField.value = norm(family.notes);
    showFamily(family);
    showLastUpdated(family.submittedAt ? new Date(family.submittedAt) : null);

    if (family.submittedAt && !fromCache) {
      setBanner('info', 'Your previous responses are loaded. Update anything below and save to make changes.');
    } else if (!fromCache) {
      setBanner('ok', `Welcome ${family.leadName}! Please confirm each member below.`);
    }

    formDetails.classList.remove('is-hidden');
    setFormEnabled(true);
  }

  async function fetchFamily(options = {}) {
    if (!familyCode) return;
    const message = Object.prototype.hasOwnProperty.call(options, 'message') ? options.message : 'Loading your RSVP…';
    setFormEnabled(false);
    if (message !== null) {
      setBanner('checking', message || 'Loading your RSVP…');
    }

    try {
      const res = await fetch(`${API_BASE}?action=getFamilyByCode&code=${encodeURIComponent(familyCode)}`);
      const payload = await res.json();

      if (!payload.ok) {
        setBanner('error', payload.error || 'We could not find that invite code.');
        hideFamily();
        formDetails.classList.add('is-hidden');
        currentFamily = null;
        setFormEnabled(false);
        return;
      }

      const family = payload.data || {};
      hydrateFamily(family);
      sessionStorage.setItem('RSVP_FAMILY_CACHE', JSON.stringify(family));
    } catch (err) {
      console.error(err);
      setBanner('error', 'Something went wrong while loading. Please try again.');
      setFormEnabled(true);
    }
  }

  function init() {
    if (initialised) return;
    initialised = true;

    familyCode = sessionStorage.getItem('RSVP_FAMILY_CODE');
    const cached = sessionStorage.getItem('RSVP_FAMILY_CACHE');

    if (!familyCode) {
      setBanner('error', 'Please return to the welcome page and enter your invite code to RSVP.');
      introText.textContent = 'Enter your invite code on the welcome page to manage your RSVP.';
      setFormEnabled(false);
      hideFamily();
      formDetails.classList.add('is-hidden');
      return;
    }

    introText.textContent = 'Review your family details below, make any updates, and save when you are ready.';

    if (cached) {
      try {
        const parsed = JSON.parse(cached);
        hydrateFamily(parsed, { fromCache: true });
        setBanner('info', 'Showing the most recent details saved on this device…');
      } catch (err) {
        console.warn('Unable to parse cached family data', err);
      }
    }

    const message = cached ? 'Refreshing your RSVP…' : 'Loading your RSVP…';
    fetchFamily({ message });
  }

  form.addEventListener('submit', async (event) => {
    event.preventDefault();
    if (!currentFamily || !familyCode) {
      setBanner('error', 'Please enter your invite code on the welcome page to begin.');
      return;
    }

    const statuses = collectStatuses();
    if (!statuses.length) {
      setBanner('error', 'We could not find any members on this invitation.');
      return;
    }

    const payload = {
      familyId: currentFamily.familyId,
      code: familyCode,
      notes: norm(notesField.value),
      statuses,
    };

    setFormEnabled(false);
    setBanner('checking', 'Saving your RSVP…');

    try {
      const res = await fetch(API_BASE, {
        method: 'POST',
        mode: 'cors',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify(payload),
      });

      if (!res.ok) {
        throw new Error(`Request failed with status ${res.status}`);
      }

      const text = await res.text();
      let data;
      try {
        data = JSON.parse(text);
      } catch (parseErr) {
        throw new Error('Received an invalid response from the server.');
      }

      if (!data.ok) {
        setBanner('error', data.error || 'Unable to save your RSVP right now.');
        setFormEnabled(true);
        return;
      }

      setBanner('ok', 'Thank you! Your RSVP has been saved.');
      await fetchFamily({ message: null });
    } catch (err) {
      console.error(err);
      setBanner('error', 'Submission failed. Please try again.');
      setFormEnabled(true);
    }
  });

  init();
})();
</script>
